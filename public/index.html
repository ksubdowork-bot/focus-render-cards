<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 포커스 그룹</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#6366f1;
      --primary-dark:#4f46e5;
      --danger:#ef4444;
      --danger-dark:#dc2626;
      --success:#10b981;
      --chip:#eef2ff;
      --chip-on:#dbeafe;
      --answer-bg:#111827; /* 짙은 회색 */
      --answer-fg:#ffffff; /* 흰색 글씨 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      padding:24px;
    }
    h1{font-size:20px;margin:0 0 16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 2px 10px rgba(15,23,42,.04); padding:16px; width:100%;
    }
    .card h2{font-size:16px;margin:0 0 12px}
    .input, textarea, select{
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      outline:none; background:#fff; color:var(--text);
    }
    .input::placeholder, textarea::placeholder{color:var(--muted)}
    textarea{min-height:96px; resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:1px solid transparent;
      font-weight:600; cursor:pointer; transition:.15s;
    }
    .btn.primary{background:var(--primary); color:#fff}
    .btn.primary:hover{background:var(--primary-dark)}
    .btn.ghost{background:#fff; color:var(--text); border-color:var(--line)}
    .btn.ghost:hover{background:#f8fafc}
    .btn.success{background:var(--success); color:#fff}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.danger:hover{background:var(--danger-dark)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .personas{display:flex;gap:12px;flex-wrap:wrap}
    .p-card{
      border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff;
      min-width:260px; max-width:360px; flex:1 1 260px; position:relative;
    }
    .p-title{font-weight:700;margin-bottom:2px}
    .p-sub{font-size:12px;color:var(--muted);margin-bottom:6px}
    .p-desc{font-size:13px;color:#334155}
    .p-actions{position:absolute; top:10px; right:10px; display:flex; gap:6px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--chip); color:#374151; border:1px solid #e5e7eb;
      padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none;
    }
    .chip.on{background:var(--chip-on); border-color:#bfdbfe}
    .answer-box{
      background:var(--answer-bg); color:var(--answer-fg);
      white-space:pre-wrap; border-radius:12px; padding:14px; line-height:1.6;
      font-size:14px; border:1px solid #111827;
    }
    .header{
      display:flex; align-items:center; gap:8px; justify-content:space-between; margin-bottom:8px;
    }
    .badge{font-size:12px; background:#eef2ff; color:#4338ca; padding:4px 8px; border-radius:999px;}
    .toggle{display:flex; align-items:center; gap:8px}
    .toggle input{transform:scale(1.1)}
    @media (max-width:840px){
      .grid-2,.grid-3{grid-template-columns:1fr}
      body{padding:16px}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI 포커스 그룹</h1>
    <div class="toggle">
      <span id="modeBadge" class="badge">DEMO</span>
      <label style="font-size:14px;color:var(--muted)">실제 모드</label>
      <input id="liveToggle" type="checkbox" />
    </div>
  </div>

  <!-- 1) 페르소나 입력 / 저장 / 목록 -->
  <section class="card">
    <h2>1) 페르소나 입력/저장</h2>
    <div class="grid-2" style="margin-bottom:8px">
      <input id="p_name" class="input" placeholder="이름/별칭 (예: 서울 30대 직장인 Alex)" />
      <input id="p_role" class="input" placeholder="역할/직무 (예: 광고 AE)" />
    </div>
    <input id="p_traits" class="input" placeholder="핵심 성향(콤마 구분) (예: 실용주의, 데이터중심, 가성비, SNS활동)" style="margin-bottom:8px"/>
    <textarea id="p_desc" placeholder="상세 설명 (예: 일상, 소비 습관, 브랜드 선호, 미디어 사용 등)"></textarea>
    <div class="toolbar" style="margin-top:10px">
      <button class="btn primary" id="btnSave">페르소나 저장</button>
      <button class="btn ghost" id="btnSample">샘플 불러오기</button>
      <button class="btn ghost" id="btnReload">목록 새로고침</button>
      <button class="btn danger" id="btnClearForm" title="입력 폼 초기화">초기화</button>
    </div>

    <div class="hint">* 저장 후 아래 카드에서 “클릭”하면 솔로/그룹 칩 선택에 자동 적용됩니다. (ID는 화면에 표시하지 않습니다)</div>

    <div id="personaList" class="personas" style="margin-top:12px"></div>
  </section>

  <!-- 2) 솔로 대화 -->
  <section class="card">
    <h2>2) 솔로 대화 (이력 유지)</h2>

    <div class="grid-2" style="margin-bottom:8px">
      <!-- ID 대신 ‘이름 드롭다운’ 노출 (내부적으로는 ID 매핑) -->
      <select id="soloPersonaSelect" class="input">
        <option value="">카드에서 클릭하거나 여기서 선택</option>
      </select>

      <select id="soloMaxContext" class="input">
        <option value="10" selected>최근 컨텍스트 최대(기본 10)</option>
        <option value="20">최근 컨텍스트 최대(기본 20)</option>
        <option value="30">최근 컨텍스트 최대(기본 30)</option>
      </select>
    </div>

    <input id="soloQuestion" class="input" placeholder="질문(예: 아이폰으로 바꾸려 한다면 오프라인에서 직접 체험 시켜줘야 할까?)" />
    <div class="toolbar" style="margin-top:10px">
      <button class="btn primary" id="btnSoloAsk">질문하기</button>
    </div>

    <div id="soloAnswer" class="answer-box" style="margin-top:12px; min-height:80px;"></div>
  </section>

  <!-- 3) 그룹 대화 -->
  <section class="card">
    <h2>3) 그룹 대화 (최대 5명)</h2>
    <div class="hint">아래 저장된 카드(칩)에서 최대 5명을 선택하세요. 순서대로 발언합니다.</div>
    <div id="groupChips" class="personas" style="margin:10px 0 12px"></div>

    <div class="grid-2" style="margin-bottom:8px">
      <input id="groupTopic" class="input" placeholder="토픽/과제 (예: 갤럭시로 바꾼다면 오프라인에서 어떤 체험이 설득력?)" />
      <select id="groupRounds" class="input">
        <option value="2" selected>라운드 수(기본 2)</option>
        <option value="3">라운드 수 3</option>
        <option value="4">라운드 수 4</option>
      </select>
    </div>

    <div class="grid-2" style="margin-bottom:10px">
      <select id="groupMaxContext" class="input">
        <option value="10" selected>최근 컨텍스트 최대(기본 10)</option>
        <option value="20">최근 컨텍스트 최대(기본 20)</option>
        <option value="30">최근 컨텍스트 최대(기본 30)</option>
      </select>
      <div class="toolbar">
        <button class="btn success" id="btnGroupStart">그룹 대화 시작</button>
      </div>
    </div>

    <div id="groupAnswer" class="answer-box" style="min-height:80px;"></div>
  </section>

  <script>
    // ---------- 상태 ----------
    let PERSONAS = [];           // [{id,name,role,traits,description}]
    let SOLO_SELECTED_ID = "";   // UI는 이름 드롭다운, 내부는 id
    const liveToggle = document.getElementById('liveToggle');
    const modeBadge = document.getElementById('modeBadge');

    liveToggle.addEventListener('change', () => {
      modeBadge.textContent = liveToggle.checked ? 'LIVE' : 'DEMO';
    });

    // ---------- API ----------
    async function api(path, opts={}) {
      const res = await fetch(path, {
        headers:{ 'Content-Type':'application/json' },
        ...opts
      });
      return res.json();
    }

    // ---------- 페르소나 CRUD ----------
    async function loadPersonas() {
      const data = await api('/api/personas-list');
      PERSONAS = Array.isArray(data.items) ? data.items : data; // 호환성
      renderPersonaCards();
      renderSoloSelect();
      renderGroupChips();
    }

    function renderPersonaCards(){
      const box = document.getElementById('personaList');
      box.innerHTML = '';
      PERSONAS.forEach(p => {
        const el = document.createElement('div');
        el.className = 'p-card';
        el.innerHTML = `
          <div class="p-actions">
            <button class="btn ghost" onclick='editPersona("${p.id}")'>편집</button>
            <button class="btn danger" onclick='deletePersona("${p.id}")'>삭제</button>
          </div>
          <div class="p-title">${escapeHtml(p.name || '이름없음')}</div>
          <div class="p-sub">${escapeHtml(p.role || '')}</div>
          <div class="p-desc">
            <div><b>성향</b> ${escapeHtml(p.traits || '')}</div>
            <div style="margin-top:4px">${escapeHtml(p.description || '')}</div>
          </div>
          <div class="hint" style="margin-top:8px">카드를 클릭하면 선택됩니다.</div>
        `;
        // 카드 클릭 → 솔로 선택/칩 토글
        el.addEventListener('click', (e) => {
          // 액션 버튼 클릭은 카드 선택에서 제외
          if ((e.target.closest('.btn'))) return;
          SOLO_SELECTED_ID = p.id;
          renderSoloSelect();           // 드롭다운 반영
          toggleChip(p.id, true);       // 그룹 칩도 ON
        });
        box.appendChild(el);
      });
    }

    function renderSoloSelect(){
      const sel = document.getElementById('soloPersonaSelect');
      const prev = SOLO_SELECTED_ID;
      sel.innerHTML = '<option value="">카드에서 클릭하거나 여기서 선택</option>';
      PERSONAS.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || '이름없음';
        sel.appendChild(opt);
      });
      // 선택 상태 유지
      if (prev) sel.value = prev;
      sel.addEventListener('change', ()=> {
        SOLO_SELECTED_ID = sel.value;
      });
    }

    function renderGroupChips(){
      const wrap = document.getElementById('groupChips');
      wrap.innerHTML = '';
      PERSONAS.forEach(p => {
        const c = document.createElement('button');
        c.className = 'chip';
        c.dataset.id = p.id;
        c.textContent = p.name || '이름없음';
        c.addEventListener('click', ()=>{
          const willOn = !c.classList.contains('on');
          // 최대 5명 제한
          if (willOn && wrap.querySelectorAll('.chip.on').length >= 5) return;
          c.classList.toggle('on');
        });
        wrap.appendChild(c);
      });
    }

    async function savePersona(){
      const idForUpdate = document.getElementById('btnSave').dataset.editId || '';
      const body = {
        id: idForUpdate || undefined,
        name: document.getElementById('p_name').value.trim(),
        role: document.getElementById('p_role').value.trim(),
        traits: document.getElementById('p_traits').value.trim(),
        description: document.getElementById('p_desc').value.trim(),
      };
      if (!body.name) return alert('이름을 입력해 주세요.');

      const isEdit = Boolean(idForUpdate);
      const url = '/api/persona';
      const method = isEdit ? 'PUT' : 'POST';
      const out = await api(url, { method, body: JSON.stringify(body) });
      if (!out.ok && !out.id && !out.item) {
        alert('저장 실패');
      }
      // 폼 초기화 & 버튼 복구
      clearForm();
      loadPersonas();
    }

    function editPersona(id){
      const p = PERSONAS.find(x=>x.id===id);
      if (!p) return;
      document.getElementById('p_name').value = p.name || '';
      document.getElementById('p_role').value = p.role || '';
      document.getElementById('p_traits').value = p.traits || '';
      document.getElementById('p_desc').value = p.description || '';
      const btn = document.getElementById('btnSave');
      btn.textContent = '업데이트';
      btn.classList.remove('primary'); btn.classList.add('success');
      btn.dataset.editId = p.id;
    }

    async function deletePersona(id){
      if (!confirm('정말 삭제할까요?')) return;
      await api('/api/persona/'+id, { method:'DELETE' });
      if (SOLO_SELECTED_ID === id) SOLO_SELECTED_ID = '';
      clearForm();
      loadPersonas();
    }

    function clearForm(){
      ['p_name','p_role','p_traits','p_desc'].forEach(id=> document.getElementById(id).value = '');
      const btn = document.getElementById('btnSave');
      btn.textContent = '페르소나 저장';
      btn.classList.remove('success'); btn.classList.add('primary');
      delete btn.dataset.editId;
    }

    function fillSample(){
      document.getElementById('p_name').value = '서울 30대 직장인 Alex';
      document.getElementById('p_role').value = '광고 AE(모바일 퍼포먼스)';
      document.getElementById('p_traits').value = '실용주의, 데이터중심, 가성비, SNS활동';
      document.getElementById('p_desc').value =
        '일상, 소비 습관, 브랜드 선호, 미디어 사용 등. 새로운 기능은 직접 써보는 걸 선호.';
    }

    // ---------- 솔로 대화 ----------
    async function askSolo(){
      const personaId = SOLO_SELECTED_ID || document.getElementById('soloPersonaSelect').value;
      if (!personaId) return alert('먼저 페르소나를 선택하세요.');
      const question = document.getElementById('soloQuestion').value.trim();
      if (!question) return alert('질문을 입력해 주세요.');
      const forceDemo = !liveToggle.checked;
      const payload = { personaId, question, forceDemo, maxContext: Number(document.getElementById('soloMaxContext').value || 10) };

      const res = await api('/api/chat-solo', {
        method:'POST', body: JSON.stringify(payload)
      });

      const box = document.getElementById('soloAnswer');
      if (!res || res.error) {
        box.textContent = '오류: ' + (res?.error || '알 수 없음');
        return;
      }
      const text = res.answer?.content || res.answer || '';
      box.textContent = text;
    }

    // ---------- 그룹 대화 ----------
    function toggleChip(id, on){
      const wrap = document.getElementById('groupChips');
      const el = Array.from(wrap.querySelectorAll('.chip')).find(x=>x.dataset.id===id);
      if (!el) return;
      if (on === true) {
        // 최대 5명 제한
        if (!el.classList.contains('on') && wrap.querySelectorAll('.chip.on').length >= 5) return;
        el.classList.add('on');
      } else if (on === false) {
        el.classList.remove('on');
      } else {
        el.classList.toggle('on');
      }
    }

    async function startGroup(){
      const ids = Array.from(document.querySelectorAll('#groupChips .chip.on')).map(x=>x.dataset.id);
      if (ids.length < 2) return alert('그룹 대화는 최소 2명 이상 선택해야 합니다.');
      const question = document.getElementById('groupTopic').value.trim();
      if (!question) return alert('토픽/과제를 입력해 주세요.');
      const rounds = Number(document.getElementById('groupRounds').value || 2);
      const forceDemo = !liveToggle.checked;
      const payload = { personaIds: ids, question, rounds, forceDemo, maxContext: Number(document.getElementById('groupMaxContext').value || 10) };

      const res = await api('/api/chat-group', {
        method:'POST', body: JSON.stringify(payload)
      });
      const box = document.getElementById('groupAnswer');
      if (!res || res.error) {
        box.textContent = '오류: ' + (res?.error || '알 수 없음');
        return;
      }
      // transcript 배열을 “이름: 말” 형식으로 출력
      let out = '';
      if (Array.isArray(res.transcript)) {
        out += res.transcript.map(t => {
          return typeof t === 'string' ? t : `${t.speaker}: ${t.text}`;
        }).join('\n');
      }
      if (res.summary) out += `\n\n[요약] ${res.summary}`;
      box.textContent = out.trim();
    }

    // ---------- 유틸 ----------
    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ---------- 이벤트 바인딩 ----------
    document.getElementById('btnSave').addEventListener('click', savePersona);
    document.getElementById('btnSample').addEventListener('click', fillSample);
    document.getElementById('btnReload').addEventListener('click', loadPersonas);
    document.getElementById('btnClearForm').addEventListener('click', clearForm);
    document.getElementById('btnSoloAsk').addEventListener('click', askSolo);
    document.getElementById('btnGroupStart').addEventListener('click', startGroup);

    // 초기 로드
    loadPersonas();
  </script>
</body>
</html>
