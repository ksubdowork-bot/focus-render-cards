<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BX AI Focus Group</title>
  <style>
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    :root{
      --brand:#5b6cff;
      --brand-ghost:#eef0ff;
      --ink:#121418;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7f8fb;
      --ok:#10b981;
      --danger:#ef4444;
      --ans-bg:#1f2430;
      --ans-fg:#ffffff;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 30px rgba(41,53,108,.10);
      --shadow-sm:0 6px 18px rgba(41,53,108,.08);
      --chip:#f2f4f7;
    }
/* --- Consent Gate (splash) --- */
.consent-backdrop{
  position:fixed; inset:0; background:rgba(17,24,39,.6);
  display:flex; align-items:center; justify-content:center; z-index:9999;
}
.consent-modal{
  width:min(680px, 92vw);
  background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25);
  padding:22px;
}
.consent-title{font-size:18px; font-weight:800; margin:0 0 8px}
.consent-desc{font-size:14px; color:#4b5563; white-space:pre-wrap; line-height:1.6}
.consent-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:18px}
/* 앱 잠금 */
.app-disabled{ filter:blur(1px); pointer-events:none; user-select:none; }

/* (선택) 모달 안의 기본 버튼 컬러가 그라데이션에 덮이지 않도록 */
.consent-modal .btn.primary{ background:var(--brand); color:#fff }
    
    *{box-sizing:border-box}

    
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
    }
    .wrap{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:20px; margin:0 0 16px; display:flex; gap:10px; align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#e9eefb; color:#4252d9}
    .mode-toggle{margin-left:auto; display:flex; gap:8px; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; padding:4px; border-radius:999px; box-shadow:var(--shadow-sm)
    }
    .pill input{display:none}
    .pill label{
      padding:6px 12px; border-radius:999px; cursor:pointer; color:var(--muted)
    }
    .pill input:checked + label{ background:var(--brand); color:#fff }

    .section{
      background:var(--card); border-radius:var(--radius);
      padding:18px; box-shadow:var(--shadow); margin:14px 0;
    }
    .sec-title{font-weight:700; margin:0 0 12px; font-size:16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .full{grid-column:1 / -1}
    input,textarea,select{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px;
      background:#fff; outline:none; transition:.15s; font:inherit;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-ghost)}
    textarea{min-height:96px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}

    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow:var(--shadow-sm); background:#f3f4f6; color:#111827;
    }
    .btn.primary{ background:var(--brand); color:#fff }
    .btn.ghost{ background:#fff }
    .btn.success{ background:var(--ok); color:#fff }
    .btn.danger{ background:#fff0f0; color:#b91c1c }

    .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px; margin-top:10px}
    .card{
      background:#fff; border:1px solid #eef0f4; border-radius:12px; padding:12px; display:flex; gap:10px; align-items:flex-start;
      box-shadow:var(--shadow-sm); position:relative;
    }
    .card .name{font-weight:700}
    .card .meta{font-size:12px; color:var(--muted); margin-top:2px}
    .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); font-size:12px; color:#555}

    .card .kebab{ position:absolute; top:8px; right:8px; display:flex; gap:6px }
    .tag { font-size:11px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#4f46e5 }

    .answer{
      background:var(--ans-bg); color:var(--ans-fg);
      border-radius:12px; padding:14px; white-space:pre-wrap; box-shadow:var(--shadow-sm)
    }
    .list-inline{display:flex; gap:8px; flex-wrap:wrap}
    .persona-pill{
      padding:10px 12px; border:1px dashed #e5e7eb; border-radius:12px; min-height:64px; background:#fff
    }

    @media (max-width:720px){
      .row{grid-template-columns:1fr}
      .mode-toggle{width:100%; justify-content:flex-end}
    }
  </style>
</head>
<body>
  <div id="appRoot" class="app-disabled">
  <div class="wrap">
    <h1>
      AI 익스피리언스 포커스 그룹
      <span id="modeBadge" class="badge">DEMO</span>
      <div class="mode-toggle">
        <div class="pill">
          <input type="radio" name="mode" id="modeDemo" value="demo" checked>
          <label for="modeDemo">Demo</label>
          <input type="radio" name="mode" id="modeLive" value="live">
          <label for="modeLive">Live</label>
        </div>
      </div>
    </h1>

    <!-- 1) 페르소나 입력/저장 -->
    <section class="section" id="secSave">
      <div class="sec-title">1) 페르소나 입력/저장 (최대 5명)</div>
      <div class="row">
        <div>
          <label>이름</label>
          <input id="pName" placeholder="예: 도경섭" />
        </div>
        <div>
          <label>모바일 기기</label>
          <input id="pRole" placeholder="예: 갤럭시 Z fold7" />
        </div>
        <div class="full">
          <label>핵심 성향(콤마 구분)</label>
          <input id="pTraits" placeholder="소셜미디어, 영포티아님, 패션, 여행, 육아" />
        </div>
        <div class="full">
          <label>상세 설명</label>
          <textarea id="pBio" placeholder="(자세할수록좋음)모바일 활용, 오프라인 체험에 관한 내용 등"></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnSavePersona">페르소나 저장</button>
        <button class="btn ghost" id="btnLoadSamples">2026트랜드 페르소나 자동입력</button>
        <button class="btn ghost" id="btnRefreshList">목록 새로고침</button>
        <button class="btn" id="btnCancelEdit" style="display:none">수정 취소</button>
      </div>

      <div class="hint">* 저장 후 아래 카드에서 “클릭”하면 해당 슬롯/그룹 자동 적용</div>

      <div class="cards" id="personaList"></div>
    </section>
    
<!-- 2) 솔로 대화 -->
<section class="section" id="secSolo">
  <div class="sec-title">2) 솔로 질문 </div>
  <div class="row">
    <div class="full">
      <label>페르소나</label>
      <select id="soloPersonaSelect"></select>
    </div>
    <div>
      <label>대화 컨텍스트 반영</label>
      <select id="soloLimit">
        <option>10</option><option selected>20</option><option>30</option><option>50</option>
      </select>
    </div>
    <div class="full">
      <label>질문</label>
      <input id="soloQuestion" placeholder="예: 새로운 모바일기기를 구매한다면 어떤기능을 직접 써보고싶을까?" />
    </div>
  </div>
  <div class="btns">
    <button class="btn primary" id="btnAskSolo">질문하기</button>
  </div>
  <!-- ✅ 하나만 남기고 aria 속성 추가 -->
  <div id="soloAnswer" class="answer" style="margin-top:12px; display:none;" aria-live="polite" aria-atomic="true"></div>
</section>
    
 <!-- 3) 그룹 대화 -->
<section class="section" id="secGroup">
  <div class="sec-title">3) 그룹 대화(최대 5명)</div>
  <div class="hint">아래 목록에서 페르소나를 선택하세요. 선택된 페르소나가 발언합니다.</div>

  <div id="groupSelected" class="list-inline" style="margin:8px 0 12px;"></div>

  <div class="row">
    <div class="full">
      <label>토픽 / 과제</label>
      <input id="groupTopic" placeholder="예: 갤럭시 팝업스토어에 간다면 무엇을 제일먼저 보고싶을까?" />
    </div>
    <div>
      <label>라운드 수(기본 2)</label>
      <select id="groupRounds"><option>1</option><option selected>2</option><option>3</option></select>
    </div>
    <div>
      <label>대화 컨텍스트 반영</label>
      <select id="groupLimit"><option>10</option><option selected>20</option><option>30</option><option>50</option></select>
    </div>
  </div>

  <div class="btns">
    <button class="btn success" id="btnStartGroup">그룹 대화 시작</button>
  </div>

  <!-- ✅ 하나만 남기고 aria 속성 추가 -->
  <div id="groupAnswer" class="answer" style="margin-top:12px; display:none;" aria-live="polite" aria-atomic="true"></div>
</section>
    
  </div>
 <footer style="
    bottom:0;
    left:0;
    width:100%;
    text-align:center;
    font-size:12px;
    color:#6b7280;
    background:#f7f8fb;  /* 배경색을 페이지와 통일 */
    padding:8px 0;
    border-top:1px solid #e5e7eb;
  ">
      Experience Design TF · All rights reserved. · Contact: <a href="mailto:k.do@cheil.com">k.do@cheil.com</a>
</footer>
</div> <!-- ✅ appRoot 닫기 -->

<!-- ✅ 동의(Consent) 모달 -->
<div id="consentGate" class="consent-backdrop" role="dialog" aria-modal="true">
  <div class="consent-modal">
    <h2 class="consent-title">안내 및 동의</h2>
<p class="consent-desc">
BX AI Focus Group App 은 페르소나를 입력하거나, 2026년 트랜드가 반영된 소비자 페르소나를 불러와 AI 모더레이터와 함께 질문·응답·토론을 진행할 수 있는 도구입니다.
본 앱은 무선 ILP 관련 내용에 특화되어 학습되어 있습니다. 따라서 질문과 인사이트는 무선 ILP의 경험, 기획, 오프라인 연계 중심으로 진행될 수 있습니다.
  
사용 방법:
1) 프로젝트에 맞는 페르소나를 직접 입력하거나, 저장된 최신 페르소나(리서치기관 정보 활용)를 선택합니다.
2) 솔로 질문 또는 그룹 대화를 통해 원하는 주제로 AI 토론을 진행합니다. 주제/ 질문이 정확하고 구체적일 수록 좋은 인사이트를 얻을 수 있습니다.
3) 대화 결과에서 프로젝트에 활용할 수 있는 인사이트를 얻습니다.

본 앱의 ILP외 타 프로젝트 이벤트/전시 관련 AI 질문·응답·토론 사용 문의는 Experience Design TF 로 연락 바랍니다.  
문의: <a href="mailto:k.do@cheil.com">k.do@cheil.com</a>

긍정적인 마인드와 AI 활용에 동의하시면 서비스를 계속 이용할 수 있습니다.
</p>
    <div class="consent-actions">
      <button id="consentReject" class="btn">취소</button>
      <button id="consentAccept" class="btn primary">동의</button>
    </div>
  </div>
</div>
<script>

  function setButtonLoading(btn, on, baseLabel = "불러오는 중"){
  if(!btn) return;
  if(on){
    if(!btn.dataset.label) btn.dataset.label = btn.textContent;
    btn.disabled = true;
    startEllipsis(btn, baseLabel); // 버튼 안에 "불러오는 중..." 점점점
  }else{
    stopEllipsis(btn);
    btn.textContent = btn.dataset.label || "2026트랜드 페르소나 자동입력";
    btn.disabled = false;
  }
}
function savePersonas(arr){
  const slim = arr.slice(0,5).map(p => ({
    name:p.name,
    role:p.role,
    traits:p.traits,
    bio:p.bio          // description 저장 안 함
  }));
  localStorage.setItem(LSK, JSON.stringify(slim));
}
  
// --- 로딩 말줄임표 애니메이션 ---
const _loadingTimers = new WeakMap();

/** el 안에 baseText + ... 를 0~3개 반복 표시 */
function startEllipsis(el, baseText = "") {
  stopEllipsis(el);
  el.setAttribute("aria-busy", "true");
  let i = 0;
  el.textContent = baseText;
  const id = setInterval(() => {
    i = (i + 1) % 4;
    el.textContent = baseText + ".".repeat(i);
  }, 400);
  _loadingTimers.set(el, id);
}
function stopEllipsis(el) {
  const id = _loadingTimers.get(el);
  if (id) {
    clearInterval(id);
    _loadingTimers.delete(el);
  }
  el.removeAttribute("aria-busy");
}

// -------- 상태 & 유틸
async function fetchWithTimeout(url, { timeout = 10000, ...opts } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeout);
  try {
    return await fetch(url, { ...opts, signal: ctrl.signal });
  } finally {
    clearTimeout(timer);
  }
} 
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const modeBadge = $("#modeBadge");
const modeDemo = $("#modeDemo");
const modeLive = $("#modeLive");

const LSK = "personas.v1"; // localStorage key
let editIndex = null;
function fillForm(p){
  $("#pName").value   = p?.name   || "";
  $("#pRole").value   = p?.role   || "";
  $("#pTraits").value = p?.traits || "";
  $("#pBio").value    = p?.bio    || "";
}
function clearForm(){ fillForm({}); }
function enterEditMode(idx, p){
  editIndex = idx;
  fillForm(p);
  $("#btnSavePersona").textContent = "수정 저장";
  $("#btnCancelEdit").style.display = "inline-block";
  $("#pName").focus();
  document.getElementById("secSave")?.scrollIntoView({behavior:"smooth", block:"start"});
}
function exitEditMode(){
  editIndex = null;
  clearForm();
  $("#btnSavePersona").textContent = "페르소나 저장";
  $("#btnCancelEdit").style.display = "none";
}
  function normalizePersona(p){
  return {
    ...p,
    // 서버/샘플에서 description으로 올 수도 있으니 bio로 흡수
    bio: (p && (p.bio ?? p.description ?? "")),
  };
}
function toast(msg){ alert(msg); }

function loadPersonas(){
  try{
    const arr = JSON.parse(localStorage.getItem(LSK) || "[]");
    const list = Array.isArray(arr) ? arr : [];
    // description만 있는 경우 bio로 매핑
    return list.map(normalizePersona);
  }catch(_){ return []; }
}
  
function addPersona(p){
  const arr = loadPersonas();
  if(arr.length >= 6){ toast("최대 6명까지 저장할 수 있어요."); return false; }
  arr.unshift(p); savePersonas(arr); return true;
}
function updatePersona(idx, p){
  const arr = loadPersonas();
  if(arr[idx]){ arr[idx] = p; savePersonas(arr); }
}
function deletePersona(idx){
  const arr = loadPersonas(); arr.splice(idx,1); savePersonas(arr);
}

function esc(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function renderPersonaList(){
  const list = loadPersonas();
  const box = $("#personaList");
  box.innerHTML = "";

  list.forEach((p, idx) => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div style="flex:1">
        <div class="name">${esc(p.name || "이름없음")}</div>
        <div class="meta">${esc(p.role || "")}</div>
        <div class="meta" style="margin-top:6px">${esc(p.traits || "")}</div>
      </div>
      <div class="kebab">
        <button class="btn ghost" data-edit>편집</button>
        <button class="btn danger" data-del>삭제</button>
      </div>
    `;

    // 카드 클릭 → 선택 적용 (편집/삭제 버튼은 제외)
    el.addEventListener("click", (e)=>{
      if(e.target.closest("[data-del]")) return;
      if(e.target.closest("[data-edit]")) return;
      applyPersonaToSelectors(p);
    });

    // 삭제
    el.querySelector("[data-del]").addEventListener("click",(e)=>{
      e.stopPropagation();
      if(confirm("이 페르소나를 삭제할까요?")){
        deletePersona(idx);
        renderPersonaList();
        refreshSelectors();
      }
    });

    // 편집 → 폼에 값 채우고 편집 모드 진입
    el.querySelector("[data-edit]").addEventListener("click",(e)=>{
      e.stopPropagation();
      enterEditMode(idx, p);
    });

    box.appendChild(el);
  });

  refreshSelectors();
  renderGroupPickArea();
}


// 솔로/그룹 선택박스 채우기
function refreshSelectors(){
  const list = loadPersonas();
  const sel = $("#soloPersonaSelect");
  const v = sel.value;
  sel.innerHTML = list.map(p => `<option value="${esc(p.name)}">${esc(p.name)}</option>`).join("");
  if(list.length===0){
    sel.innerHTML = `<option value="" disabled selected>저장된 페르소나 없음</option>`;
  }else if(v && list.some(p=>p.name===v)){
    sel.value = v;
  }
  renderGroupPickArea();
}

function applyPersonaToSelectors(p){
  $("#soloPersonaSelect").value = p.name;
  toggleGroupPerson(p.name);
}

// 그룹 선택 UI
function renderGroupPickArea(){
  const box = $("#groupSelected");
  const list = loadPersonas();
  box.innerHTML = "";
  list.forEach(p=>{
    const chip = document.createElement("div");
    chip.className = "persona-pill";
    chip.dataset.name = p.name;
    chip.innerHTML = `
      <div style="font-weight:700">${esc(p.name)}</div>
      <div class="meta">${esc(p.role)}</div>
      <div class="meta">${esc(p.traits)}</div>
    `;
    chip.addEventListener("click", ()=> toggleGroupPerson(p.name));
    box.appendChild(chip);
  });
  updateGroupSelectedStyles();
}
function getGroupSelected(){
  const set = JSON.parse(sessionStorage.getItem("group.selected")||"[]");
  return Array.isArray(set)? set : [];
}
function setGroupSelected(arr){
  sessionStorage.setItem("group.selected", JSON.stringify(arr.slice(0,5)));
  updateGroupSelectedStyles();
}
function toggleGroupPerson(name){
  let arr = getGroupSelected();
  if(arr.includes(name)) arr = arr.filter(x=>x!==name);
  else{
    if(arr.length>=6){ toast("그룹은 최대 6명까지 선택 가능합니다."); return; }
    arr.push(name);
  }
  setGroupSelected(arr);
}
function updateGroupSelectedStyles(){
  const selected = new Set(getGroupSelected());
  $$("#groupSelected .persona-pill").forEach(el=>{
    if(selected.has(el.dataset.name)){
      el.style.borderColor = "var(--brand)";
      el.style.background = "#fafaff";
    }else{
      el.style.borderColor = "#e5e7eb";
      el.style.background = "#fff";
    }
  });
}
  // 구글샘플로드
async function loadSamplePersonas(
  triggerBtn,
  { timeoutGAS=9000, timeoutLocal=4000, replace=true, force=null } = {}
) {
  // 최후 폴백(하드코드)
  const localFallback = [
    // { name:"The Pioneers", role:"iPhone 16 Pro", traits:"...", bio:"..." },
  ];

  const mapToItem = (p) => ({
    name: p?.name || "",
    role: p?.role || "",
    traits: p?.traits || "",
    bio:   p?.bio ?? p?.description ?? ""
  });

  // replace 모드면 잠깐 리스트 비워서 "로컬이 먼저 보임" 착시 제거
  if (replace) {
    savePersonas([]);
    renderPersonaList();
  }

  let source = "localFallback";
  try {
    setButtonLoading(triggerBtn, true, "불러오는 중");

    // ---- 1) GAS (강제 옵션 & 캐시 무효화)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxVmevb03FhN8mlXS5zqN7QiTrMte_W318fPS3n68p1b1iIFDBGm0MX-Rx2xRTIBP1W/exec" + Date.now();
    let items = null;

    const wantGAS = (force === "GAS" || force === null);
    if (wantGAS) {
      try {
        const r = await fetchWithTimeout(GAS_URL, {
          timeout: timeoutGAS,
          cache: "no-store",
          headers: { "pragma":"no-cache", "cache-control":"no-cache" }
        });
        if (!r.ok) throw new Error(`GAS HTTP ${r.status}`);
        const data = await r.json();
        if (data?.ok && Array.isArray(data.items) && data.items.length) {
          items = data.items.map(mapToItem);
          source = "GAS";
        } else if (force === "GAS") {
          throw new Error("GAS returned empty or ok:false");
        }
      } catch (err) {
        console.warn("[GAS fallback]", err?.message || err);
        if (force === "GAS") throw err; // 강제 모드면 바로 실패
      }
    }

    // ---- 2) 서버(personas-list)
    const wantServer = (force === "server" || (force === null && !items));
    if (wantServer) {
      try {
        const r2 = await fetchWithTimeout("/personas-list?t="+Date.now(), {
          timeout: timeoutLocal,
          cache: "no-store",
          headers: { "pragma":"no-cache", "cache-control":"no-cache" }
        });
        if (!r2.ok) throw new Error(`SERVER HTTP ${r2.status}`);
        const data2 = await r2.json();
        if (data2?.ok && Array.isArray(data2.items) && data2.items.length) {
          items = data2.items.map(mapToItem);
          source = "server";
        } else if (force === "server") {
          throw new Error("server returned empty");
        }
      } catch (err2) {
        console.warn("[server fallback]", err2?.message || err2);
        if (force === "server") throw err2; // 강제 모드면 바로 실패
      }
    }

    // ---- 3) 로컬 하드코드
    if (!items || !items.length) {
      items = localFallback.map(mapToItem);
      source = "localFallback";
    }

    // 저장: 원격 오면 교체(replace=true) / 아니면 병합
    const cur = loadPersonas().map(mapToItem);
    let finalList;
    if (replace && (source === "GAS" || source === "server")) {
      finalList = items.slice(0,5);
    } else {
      finalList = [...items, ...cur].reduce((acc,p)=>{
        if (!acc.find(x=>x.name===p.name)) acc.push(p);
        return acc;
      },[]).slice(0,5);
    }

    savePersonas(finalList);
    renderPersonaList();

    const msgMap = {
      GAS: "구글 시트에서 불러왔어요.",
      server: "서버에서 불러왔어요.",
      localFallback: "샘플로 채웠어요."
    };
    toast(msgMap[source] + (replace ? " (기존 교체)" : " (병합)"));
    console.log("[personas source ->]", source, finalList);

  } catch (e) {
    console.error("[loadSamplePersonas fatal]", e);
    // 최후 폴백
    const cur = loadPersonas().map(mapToItem);
    const merged = [...localFallback.map(mapToItem), ...cur].reduce((acc,p)=>{
      if (!acc.find(x=>x.name===p.name)) acc.push(p);
      return acc;
    },[]).slice(0,5);
    savePersonas(merged);
    renderPersonaList();
    toast("오프라인으로 로컬 샘플로 채웠어요.");
  } finally {
    setButtonLoading(triggerBtn, false);
  }
}
// 위까지가 구글시트


  
function currentMode(){ return modeLive.checked ? "live" : "demo"; }
modeDemo.addEventListener("change", ()=> modeChanged());
modeLive.addEventListener("change", ()=> modeChanged());
function modeChanged(){
  const m = currentMode();
  modeBadge.textContent = m==="live" ? "LIVE" : "DEMO";
  modeBadge.style.background = m==="live" ? "#e6fff3" : "#e9eefb";
  modeBadge.style.color = m==="live" ? "#15803d" : "#4252d9";
}

// -------- 솔로 대화
$("#btnAskSolo").addEventListener("click", async ()=>{
  const name = $("#soloPersonaSelect").value;
  const q = $("#soloQuestion").value.trim();
  const limit = parseInt($("#soloLimit").value,10) || 20;
  if(!name) return toast("페르소나를 선택하세요.");
  if(!q) return toast("질문을 적어주세요.");
  const p = loadPersonas().find(x=>x.name===name);
  if(!p) return toast("선택한 페르소나를 찾을 수 없습니다.");

  const out = $("#soloAnswer");
  out.style.display = "block";

  if(currentMode()==="demo"){
    out.textContent = `[DEMO] ${p.name}의 시점으로 답변합니다.\n\nQ. ${q}\n\n- (데모 응답) 실제 모드는 서버 API 연결 후 작동합니다.`;
    return;
  }

  try{
    startEllipsis(out, "[LIVE] AI 응답 작성중");
    const res = await fetch("/chat/solo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ persona:p, question:q, historyLimit:limit })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status} - ${t}`);
    }
    const data = await res.json();
    out.textContent = (data.answer||"").trim() || "(빈 응답)";
  }catch(err){
    out.textContent = `오류: ${err.message}`;
  } finally {
    stopEllipsis(out);
  }
});

// -------- 그룹 대화
$("#btnStartGroup").addEventListener("click", async ()=>{
  const names = getGroupSelected();
  const list = loadPersonas().filter(p=>names.includes(p.name));
  if(list.length===0) return toast("그룹에 참여시킬 페르소나를 한 명 이상 선택하세요.");
  const topic = $("#groupTopic").value.trim() || "자유 토론";
  const rounds = parseInt($("#groupRounds").value,10) || 2;
  const limit = parseInt($("#groupLimit").value,10) || 20;

  const out = $("#groupAnswer");
  out.style.display = "block";

  if(currentMode()==="demo"){
    const heads = list.map(p=>p.name).join(", ");
    out.textContent = `[DEMO] (${heads}) 라운드 ${rounds}회 대화 요약.\n\n- (데모 응답) 실제 모드는 서버 API 연결 후 작동합니다.`;
    return;
  }

  try{
    startEllipsis(out, "[LIVE] 뒤에서 몰래 이야기중");
    const res = await fetch("/chat/group",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ personas:list, topic, rounds, historyLimit:limit })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status} - ${t}`);
    }
    const data = await res.json();
    if (Array.isArray(data.transcript)) {
      const lines = data.transcript.map(it => `${it.speaker}: ${it.text}`).join("\n");
      const sum = data.summary ? `\n\n요약: ${data.summary}` : "";
      out.textContent = `${lines}${sum}`;
    } else {
      out.textContent = (data.transcript || data.summary || "").trim() || "(빈 응답)";
    }
  }catch(err){
    out.textContent = `오류: ${err.message}`;
  } finally {
    stopEllipsis(out);
  }
});

// -------- 저장/편집/삭제
// 저장(신규 or 수정 저장)
$("#btnSavePersona").addEventListener("click", ()=>{
  const p = {
    name: $("#pName").value.trim(),
    role: $("#pRole").value.trim(),
    traits: $("#pTraits").value.trim(),
    bio: $("#pBio").value.trim()
  };
  if(!p.name){ toast("이름은 필수입니다."); return; }

  if(editIndex !== null){
    updatePersona(editIndex, p);   // 덮어쓰기
    exitEditMode();
  }else{
    if(!addPersona(p)) return;     // 최대 5명 가드
    clearForm();
  }
  renderPersonaList();
});

// 수정 취소
$("#btnCancelEdit").addEventListener("click", exitEditMode);
$("#btnLoadSamples").addEventListener("click", (e)=>{
  loadSamplePersonas(e.currentTarget, { replace:true });
});
  $("#btnRefreshList").addEventListener("click", renderPersonaList);

// 초기화
modeChanged();
renderPersonaList();

/* ---------- Consent Gate (단일, 견고 버전) ---------- */
/* ---------- Consent Gate (단일) ---------- */
(function () {
  function ready(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }
  ready(() => {
    const gate  = document.getElementById('consentGate');
    const app   = document.getElementById('appRoot');
    const btnOk = document.getElementById('consentAccept');
    const btnNo = document.getElementById('consentReject');
    if (!gate || !app || !btnOk || !btnNo) return;

    openGate();
    btnOk.addEventListener('click', closeGate, { passive: true });
    btnNo.addEventListener('click', openGate,  { passive: true });

    function openGate(){
      // 화면/접근성/포인터 모두 "열림" 상태로
      gate.hidden = false;
      gate.style.display = 'flex';      // ✅ 확실히 보이도록
      gate.removeAttribute('aria-hidden');
      gate.removeAttribute('inert');
      app.classList.add('app-disabled');
    }
    function closeGate(){
      // 화면/접근성/포인터 모두 "닫힘" 상태로
      gate.hidden = true;
      gate.style.display = 'none';      // ✅ 눈에 보이는 잔상 제거 (Safari 등 대응)
      gate.setAttribute('aria-hidden','true');
      gate.setAttribute('inert','');
      app.classList.remove('app-disabled');
    }
  });
})();
</script>
</body>
</html>
