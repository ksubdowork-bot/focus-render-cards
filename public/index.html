<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BX AI Focus Group</title>
  <style>
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    :root{
      --brand:#5b6cff;
      --brand-ghost:#eef0ff;
      --ink:#121418;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7f8fb;
      --ok:#10b981;
      --danger:#ef4444;
      --ans-bg:#1f2430;
      --ans-fg:#ffffff;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 30px rgba(41,53,108,.10);
      --shadow-sm:0 6px 18px rgba(41,53,108,.08);
      --chip:#f2f4f7;
    }
    /* --- Consent Gate (splash) --- */
    .consent-backdrop{
      position:fixed; inset:0; background:rgba(17,24,39,.6);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .consent-modal{
      width:min(680px, 92vw);
      background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:22px;
    }
    .consent-title{font-size:18px; font-weight:800; margin:0 0 8px}
    .consent-desc{font-size:14px; color:#4b5563; white-space:pre-wrap; line-height:1.6}
    .consent-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:18px}
    /* 앱 잠금 */
    .app-disabled{ filter:blur(1px); pointer-events:none; user-select:none; }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
    }
    .wrap{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:20px; margin:0 0 16px; display:flex; gap:10px; align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#e6fff3; color:#15803d}

    .section{
      background:var(--card); border-radius:var(--radius);
      padding:18px; box-shadow:var(--shadow); margin:14px 0;
    }
    .sec-title{font-weight:700; margin:0 0 12px; font-size:16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .full{grid-column:1 / -1}
    input,textarea,select{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px;
      background:#fff; outline:none; transition:.15s; font:inherit;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-ghost)}
    textarea{min-height:96px; resize:vertical}
    .hint{font-size:12px; color:#6b7280; margin-top:8px}

    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow:var(--shadow-sm); background:#f3f4f6; color:#111827;
    }
    .btn.primary{ background:var(--brand); color:#fff }
    .btn.ghost{ background:#fff }
    .btn.success{ background:var(--ok); color:#fff }
    .btn.danger{ background:#fff0f0; color:#b91c1c }

    .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px; margin-top:10px}
    .card{
      background:#fff; border:1px solid #eef0f4; border-radius:12px; padding:12px; display:flex; gap:10px; align-items:flex-start;
      box-shadow:var(--shadow-sm); position:relative;
    }
    .card .name{font-weight:700}
    .card .meta{font-size:12px; color:#6b7280; margin-top:2px}
    .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:#f2f4f7; font-size:12px; color:#555}
    .card .kebab{ position:absolute; top:8px; right:8px; display:flex; gap:6px }
    .tag { font-size:11px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#4f46e5 }

    .answer{
      background:var(--ans-bg); color:var(--ans-fg);
      border-radius:12px; padding:14px; white-space:pre-wrap; box-shadow:var(--shadow-sm)
    }
    .list-inline{display:flex; gap:8px; flex-wrap:wrap}
    .persona-pill{
      padding:10px 12px; border:1px dashed #e5e7eb; border-radius:12px; min-height:64px; background:#fff
    }

    @media (max-width:720px){
      .row{grid-template-columns:1fr}
    }
  </style>
  <script defer>
(function () {
  function ready(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }
  ready(() => {
    const gate  = document.getElementById('consentGate');
    const app   = document.getElementById('appRoot');
    const btnOk = document.getElementById('consentAccept');
    const btnNo = document.getElementById('consentReject');
    if (!gate || !app || !btnOk || !btnNo) return;

    // 처음엔 열어둠
    openGate();
    btnOk.addEventListener('click', closeGate);
    btnNo.addEventListener('click', () => { window.location.href = 'https://www.google.com'; });
    
    function openGate(){
      gate.hidden = false;
      gate.style.display = 'flex';
      app.classList.add('app-disabled');
    }
    function closeGate(){
      gate.hidden = true;
      gate.style.display = 'none';
      app.classList.remove('app-disabled');
    }
  });
})();
</script>
</head>
<body>
  <div id="appRoot" class="app-disabled">
  <div class="wrap">
    <h1>
      AI 익스피리언스 포커스 그룹
      <span id="modeBadge" class="badge">LIVE</span>
    </h1>

    <!-- 1) 페르소나 입력/저장 -->
    <section class="section" id="secSave">
      <div class="sec-title">1) 페르소나 입력/저장 (최대 6명)</div>
      <div class="row">
        <div>
          <label>이름</label>
          <input id="pName" placeholder="예: 한주명" />
        </div>
        <div>
          <label>모바일 기기</label>
          <input id="pRole" placeholder="예: 갤럭시 Z fold7" />
        </div>
        <div class="full">
          <label>핵심 성향(콤마 구분)</label>
          <input id="pTraits" placeholder="소셜미디어, 영포티아님, 패션, 여행, 육아" />
        </div>
        <div class="full">
          <label>상세 설명</label>
          <textarea id="pBio" placeholder="핵심 가치 :  시간을 최우선 자원으로 보고 업무 효율·디스트랙션 최소화를 중시. 의미 있는 경험·관계에 시간을 재투자. 시간 절약형 서비스와 렌탈·부분 소유 모델 선호(소유 대신 활용 효율), 미감·미식 감수성과 ‘삶의 품위’도 추구, Lifestyle : 월요일 싱가포르, 수요일 도쿄, 금요일 서울. 아침 공항 라운지에서 문서를 검토하고, 비행 중 콜 2건을 처리. 호텔 체크인 즉시 ‘업무 알림만 허용’ 프로필로 전환해 산만함을 줄인다. 출퇴근은 모빌리티 구독, 출장 중 촬영은 장비 렌탈(부분 소유)로 해결—관리 비용 대신 ‘즉시 가용성’을 산다. 출장이 많아 공유오피스·렌탈 스튜디오를 적극 활용해 ‘소유하지 않고 활용하는 삶’을 실천한다. 저녁엔 가족과 식사 약속을 고정 슬롯으로 지키고, 도시마다 미식을 즐긴다, Device Habit : S펜으로 클라이언트 피드백을 PDF에 직접 기입, S펜으로 바로 메모·수정, 멀티 테스킹, AI 기반 일정 정리와 고화질 카메라로 출장 중 문서·계약서 즉시 스캔/공유, 워치로 다양한 시차에 따른 수면질과 건강 관리, Lock-in : 워크프로세스 연결 및 주변 기기활용, 수면 스코어, 수면 코칭으로 건강기능 관리  “동시에 여러 일을 해야 하는 내 환경에서는 갤럭시의 멀티태스킹과 AI 기능이 시간을 돈처럼 지켜준다.”"></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnSavePersona">페르소나 저장</button>
        <button class="btn ghost" id="btnLoadSamples">2026트랜드 페르소나 자동입력</button>
        <button class="btn" id="btnCancelEdit" style="display:none">수정 취소</button>
      </div>

      <div class="hint">* 저장 후 아래 카드에서 “클릭”하면 해당 슬롯/그룹 자동 적용</div>
      <div class="cards" id="personaList"></div>
    </section>
    
    <!-- 2) 솔로 대화  -->
    <section class="section" id="secSolo">
      <div class="sec-title">2) 솔로 질문 </div>
      <div class="row">
        <div class="full">
          <label>페르소나</label>
          <select id="soloPersonaSelect"></select>
        </div>
        <div>
          <label>대화 컨텍스트 반영</label>
          <select id="soloLimit">
            <option>10</option><option selected>20</option><option>30</option><option>50</option>
          </select>
        </div>
        <div class="full">
          <label>질문</label>
          <input id="soloQuestion" placeholder="예: 경쟁사 대비 제품 체험이 당신의 가치관과 맞닿아 있다고 느끼려면 어떤 메시지나 체험이 필요할까?" />
        </div>
      </div>
      <div class="btns">
        <button class="btn primary" id="btnAskSolo">질문하기</button>
      </div>
      <div id="soloAnswer" class="answer" style="margin-top:12px; display:none;" aria-live="polite" aria-atomic="true"></div>
    </section>
    
    <!-- 3) 그룹 대화 -->
    <section class="section" id="secGroup">
      <div class="sec-title">3) 그룹 대화(최대 4명)</div>
      <div class="hint">아래 목록에서 페르소나를 선택하세요. 선택된 페르소나가 발언합니다.</div>

      <div id="groupSelected" class="list-inline" style="margin:8px 0 12px;"></div>

      <div class="row">
        <div class="full">
          <label>토픽 / 과제</label>
          <input id="groupTopic" placeholder="예: 팝업스토어에서 반드시 보고·체험하고 싶은 요소(예: AI, 카메라, 체험 프로그램)는 무엇인가요? 체험 후 친구나 SNS에 공유하고 싶은 순간은 어떤 모습일까요?" />
        </div>
        <div>
          <label>라운드 수(기본 2)</label>
          <select id="groupRounds">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </div>
        <div>
          <label>대화 컨텍스트 반영</label>
          <select id="groupLimit"><option>10</option><option selected>20</option><option>30</option><option>50</option></select>
        </div>
      </div>

      <div class="btns">
        <button class="btn success" id="btnStartGroup">그룹 대화 시작</button>
      </div>

      <div id="groupAnswer" class="answer" style="margin-top:12px; display:none;" aria-live="polite" aria-atomic="true"></div>
    </section>
  </div>

  <footer style="
    bottom:0;
    left:0;
    width:100%;
    text-align:center;
    font-size:12px;
    color:#6b7280;
    background:#f7f8fb;
    padding:8px 0;
    border-top:1px solid #e5e7eb;">
    BX AI Focus Group App 은 ChatGPT API를 활용하여 제작되었습니다.
	Experience Design TF · All rights reserved. · Contact: <a href="mailto:k.do@cheil.com">k.do@cheil.com</a>
  </footer>
</div>

<!-- ✅ 동의(Consent) 모달 -->
<div id="consentGate" class="consent-backdrop" role="dialog" aria-modal="true">
  <div class="consent-modal">
    <h2 class="consent-title">안내 및 동의</h2>
    <p class="consent-desc">
R.T.F.M.
BX AI Focus Group App은 Experience Design TF에서 자체 개발한, 오프라인 이벤트 인사이트 도출을 위한 전문 AI 툴입니다.
TF에서 지속 리서치/ 업데이트 중인 2026년 최신 소비자 트렌드가 반영된 페르소나를 활용, 또는 사용자 입력 기반, AI 모더레이터와 함께 질문·응답·토론을 진행할 수 있습니다.

사용 방법
 1.최신 트렌드 기반 페르소나를 불러오거나, 프로젝트 목적에 맞는 페르소나를 직접 입력합니다.
 2.솔로 질문 또는 그룹 토론을 통해 원하는 인사이트 추출. 질문이 구체적일수록 정교한 인사이트를 얻을 수 있습니다.

본 앱은 무선 ILP 관련 경험·기획·오프라인 연계에 특화된 학습 데이터를 바탕으로, 실제 ILP 프로젝트 적용이 가능한 인사이트를 제공합니다.
ILP 이외의 프로젝트 활용 문의는 Experience Design TF로 문의 바랍니다.<a href="mailto:k.do@cheil.com">k.do@cheil.com</a>

취소를 누르시면 뻔한 툴로 연결됩니다.
긍정적인 태도로 AI 활용을 원하실경우 동의 하여 서비스를 계속 이용하실 수 있습니다.
		
</p>
    <div class="consent-actions">
      <button id="consentReject" class="btn">취소</button>
      <button id="consentAccept" class="btn primary">동의</button>
    </div>
  </div>
</div>

<script>
// --- 캐시 유틸 ---
const LSK_PERSONAS = "personas.v1";
const LSK_PERSONAS_CACHE = "personas.cache";

function savePersonasCache(items){
  const payload = { savedAt: Date.now(), items };
  localStorage.setItem(LSK_PERSONAS_CACHE, JSON.stringify(payload));
}
function loadPersonasCache(){
  try{
    const raw = localStorage.getItem(LSK_PERSONAS_CACHE);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || !Array.isArray(parsed.items)) return null;
    return parsed.items;
  }catch(_){ return null; }
}
function setButtonLoading(btn, on, baseLabel = "불러오는 중"){
  if(!btn) return;
  if(on){
    if(!btn.dataset.label) btn.dataset.label = btn.textContent;
    btn.disabled = true;
    startEllipsis(btn, baseLabel);
  }else{
    stopEllipsis(btn);
    btn.textContent = btn.dataset.label || "2026트랜드 페르소나 자동입력";
    btn.disabled = false;
  }
}
function savePersonas(arr){
  const slim = arr.slice(0,6).map(p => ({
    name:p.name,
    role:p.role,
    traits:p.traits,
    bio:p.bio
  }));
  localStorage.setItem(LSK, JSON.stringify(slim));
}

// --- 로딩 말줄임표 애니메이션 ---
const _loadingTimers = new WeakMap();
function startEllipsis(el, baseText = "") {
  stopEllipsis(el);
  el.setAttribute("aria-busy", "true");
  let i = 0;
  el.textContent = baseText;
  const id = setInterval(() => {
    i = (i + 1) % 4;
    el.textContent = baseText + ".".repeat(i);
  }, 400);
  _loadingTimers.set(el, id);
}
function stopEllipsis(el) {
  const id = _loadingTimers.get(el);
  if (id) {
    clearInterval(id);
    _loadingTimers.delete(el);
  }
  el.removeAttribute("aria-busy");
}

// -------- 상태 & 유틸
async function fetchWithTimeout(url, { timeout = 10000, ...opts } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeout);
  try {
    return await fetch(url, { ...opts, signal: ctrl.signal });
  } finally {
    clearTimeout(timer);
  }
}
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const LSK = "personas.v1"; // localStorage key
let editIndex = null;

function fillForm(p){
  $("#pName").value   = p?.name   || "";
  $("#pRole").value   = p?.role   || "";
  $("#pTraits").value = p?.traits || "";
  $("#pBio").value    = p?.bio    || "";
}
function clearForm(){ fillForm({}); }
function enterEditMode(idx, p){
  editIndex = idx;
  fillForm(p);
  $("#btnSavePersona").textContent = "수정 저장";
  $("#btnCancelEdit").style.display = "inline-block";
  $("#pName").focus();
  document.getElementById("secSave")?.scrollIntoView({behavior:"smooth", block:"start"});
}
function exitEditMode(){
  editIndex = null;
  clearForm();
  $("#btnSavePersona").textContent = "페르소나 저장";
  $("#btnCancelEdit").style.display = "none";
}
function normalizePersona(p){
  return { ...p, bio: (p && (p.bio ?? p.description ?? "")) };
}
function toast(msg){ alert(msg); }

function loadPersonas(){
  try{
    const arr = JSON.parse(localStorage.getItem(LSK) || "[]");
    const list = Array.isArray(arr) ? arr : [];
    return list.map(normalizePersona);
  }catch(_){ return []; }
}

function addPersona(p){
  const arr = loadPersonas();
  if(arr.length >= 6){ toast("최대 6명까지 저장할 수 있어요."); return false; }
  arr.unshift(p); savePersonas(arr); return true;
}
function updatePersona(idx, p){
  const arr = loadPersonas();
  if(arr[idx]){ arr[idx] = p; savePersonas(arr); }
}
function deletePersona(idx){
  const arr = loadPersonas(); arr.splice(idx,1); savePersonas(arr);
}

function esc(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function renderPersonaList(){
  const list = loadPersonas();
  const box = $("#personaList");
  box.innerHTML = "";

  list.forEach((p, idx) => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div style="flex:1">
        <div class="name">${esc(p.name || "이름없음")}</div>
        <div class="meta">${esc(p.role || "")}</div>
        <div class="meta" style="margin-top:6px">${esc(p.traits || "")}</div>
      </div>
      <div class="kebab">
        <button class="btn ghost" data-edit>편집</button>
        <button class="btn danger" data-del>삭제</button>
      </div>
    `;
    el.addEventListener("click", (e)=>{
      if(e.target.closest("[data-del]")) return;
      if(e.target.closest("[data-edit]")) return;
      applyPersonaToSelectors(p);
    });
    el.querySelector("[data-del]").addEventListener("click",(e)=>{
      e.stopPropagation();
      if(confirm("이 페르소나를 삭제할까요?")){
        deletePersona(idx);
        renderPersonaList();
        refreshSelectors();
      }
    });
    el.querySelector("[data-edit]").addEventListener("click",(e)=>{
      e.stopPropagation();
      enterEditMode(idx, p);
    });
    box.appendChild(el);
  });

  refreshSelectors();
  renderGroupPickArea();
}

// 솔로/그룹 선택박스 채우기
function refreshSelectors(){
  const list = loadPersonas();
  const sel = $("#soloPersonaSelect");
  const v = sel.value;
  sel.innerHTML = list.map(p => `<option value="${esc(p.name)}">${esc(p.name)}</option>`).join("");
  if(list.length===0){
    sel.innerHTML = `<option value="" disabled selected>저장된 페르소나 없음</option>`;
  }else if(v && list.some(p=>p.name===v)){
    sel.value = v;
  }
  renderGroupPickArea();
}

function applyPersonaToSelectors(p){
  $("#soloPersonaSelect").value = p.name;
  toggleGroupPerson(p.name);
}

// 그룹 선택 UI
function renderGroupPickArea(){
  const box = $("#groupSelected");
  const list = loadPersonas();
  box.innerHTML = "";
  list.forEach(p=>{
    const chip = document.createElement("div");
    chip.className = "persona-pill";
    chip.dataset.name = p.name;
    chip.innerHTML = `
      <div style="font-weight:700">${esc(p.name)}</div>
      <div class="meta">${esc(p.role)}</div>
      <div class="meta">${esc(p.traits)}</div>
    `;
    chip.addEventListener("click", ()=> toggleGroupPerson(p.name));
    box.appendChild(chip);
  });
  updateGroupSelectedStyles();
}
function getGroupSelected(){
  const set = JSON.parse(sessionStorage.getItem("group.selected")||"[]");
  return Array.isArray(set)? set : [];
}
function setGroupSelected(arr){
  sessionStorage.setItem("group.selected", JSON.stringify(arr.slice(0,4)));
  updateGroupSelectedStyles();
}
function toggleGroupPerson(name){
  let arr = getGroupSelected();
  if(arr.includes(name)) arr = arr.filter(x=>x!==name);
  else{
    if(arr.length>=4){ toast("그룹은 최대 4명까지 선택 가능합니다."); return; }
    arr.push(name);
  }
  setGroupSelected(arr);
}
function updateGroupSelectedStyles(){
  const selected = new Set(getGroupSelected());
  $$("#groupSelected .persona-pill").forEach(el=>{
    if(selected.has(el.dataset.name)){
      el.style.borderColor = "var(--brand)";
      el.style.background = "#fafaff";
    }else{
      el.style.borderColor = "#e5e7eb";
      el.style.background = "#fff";
    }
  });
}

// 구글 시트만 호출 + 성공 시 캐시, 실패 시 캐시 폴백
async function loadSamplePersonas(triggerBtn, {
  timeoutGAS = 12000,
  replace = true,
  sheet,
  limit = 5
} = {}) {
  const BASE = "https://script.google.com/macros/s/AKfycbwUB7ATmDaDjuOKGrlRlTrxUuWf8yUg9_boJrGOmbr6ocqqCdS5aQf3giUKpxHLr3_e/exec";
  const qs = new URLSearchParams();
  if (sheet) qs.set("sheet", sheet);
  if (limit) qs.set("limit", String(limit));
  qs.set("t", Date.now());
  const GAS_URL = `${BASE}?${qs.toString()}`;

  const mapToItem = (p) => ({
    name:   p?.name   || "",
    role:   p?.role   || "",
    traits: p?.traits || "",
    bio:    p?.bio ?? p?.description ?? ""
  });

  const readAsJson = async (res) => {
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    let raw;
    try {
      raw = await res.text();
    } catch(e) { throw new Error(`응답 바디 읽기 실패: ${e?.message || e}`); }
    const preview = raw.slice(0, 180).replace(/\s+/g, " ");
    try { return JSON.parse(raw); }
    catch { throw new Error(`GAS가 JSON이 아닙니다. ct=${ct} preview="${preview}"`); }
  };

  try {
    setButtonLoading(triggerBtn, true, "불러오는 중");
    const r = await fetchWithTimeout(GAS_URL, {
      timeout: timeoutGAS, method: "GET", cache: "no-store", credentials: "omit"
    });

    const statusInfo = `status=${r.status}, ct="${(r.headers.get("content-type")||"").toLowerCase()}"`;
    if (!r.ok) {
      const errText = await r.text().catch(()=>"(본문 읽기 실패)");
      throw new Error(`GAS HTTP ${r.status}. ${statusInfo}. body="${errText.slice(0,180)}"`);
    }

    const data = await readAsJson(r);
    if (!(data?.ok && Array.isArray(data.items) && data.items.length)) {
      throw new Error(`GAS ok:false 또는 items 비어있음. ${statusInfo}`);
    }

    const items = data.items.map(mapToItem);
    savePersonasCache(items);

    const cur = loadPersonas().map(mapToItem);
    const finalList = replace
      ? items.slice(0, 6)
      : [...items, ...cur]
          .filter((p, i, arr) => p.name && arr.findIndex(x => x.name === p.name) === i)
          .slice(0, 6);

    savePersonas(finalList);
    renderPersonaList();
    toast("불러오기 성공.");
    requestAnimationFrame(() => {
      const sec = document.getElementById("secSolo");
      if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
      const list = loadPersonas();
      const sel = document.getElementById("soloPersonaSelect");
      if (sel && !sel.value && list.length) sel.value = list[0].name;
      const q = document.getElementById("soloQuestion");
      if (q) q.focus();
    });
  } catch (err) {
    console.error("[GAS fetch error]", err);
    const msg = (err && err.message) ? err.message : String(err);
    const cached = loadPersonasCache();
    if (cached?.length) {
      const items = cached.map(mapToItem).slice(0, 6);
      savePersonas(items);
      renderPersonaList();
      toast(`원격 오류(캐시로 대체): ${msg}`);
    } else {
      toast(`불러오기 실패, 페르소나를 직접 입력하세요.\n${msg}`);
    }
  } finally {
    setButtonLoading(triggerBtn, false);
  }
}

// -------- 솔로 대화 (항상 LIVE, 실패 시 토스트만)
$("#btnAskSolo").addEventListener("click", async ()=>{
  const name = $("#soloPersonaSelect").value;
  const q = $("#soloQuestion").value.trim();
  const limit = parseInt($("#soloLimit").value,10) || 20;
  if(!name) return toast("페르소나를 선택하세요.");
  if(!q) return toast("질문을 적어주세요.");
  const p = loadPersonas().find(x=>x.name===name);
  if(!p) return toast("선택한 페르소나를 찾을 수 없습니다.");

  const out = $("#soloAnswer");
  out.style.display = "block";

  try{
    startEllipsis(out, "똘똘하게 말하고 싶어서 생각중");
    const res = await fetch("/chat/solo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ persona:p, question:q, historyLimit:limit })
    });
    if(!res.ok){
      toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
      return;
    }
    const data = await res.json();
    if (!data?.ok) {
      toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
      return;
    }
    out.textContent = (data.answer||"").trim() || "(빈 응답)";
  }catch(err){
    console.error(err);
    toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
  } finally {
    stopEllipsis(out);
  }
});

// -------- 그룹 대화 (항상 LIVE, 실패 시 토스트만)
$("#btnStartGroup").addEventListener("click", async ()=>{
  const names = getGroupSelected();
  const list = loadPersonas().filter(p=>names.includes(p.name));
  if(list.length===0) return toast("그룹에 참여시킬 페르소나를 한 명 이상 선택하세요.");
  const topic = $("#groupTopic").value.trim() || "자유 토론";
  const rounds = parseInt($("#groupRounds").value,10) || 2;
  const limit = parseInt($("#groupLimit").value,10) || 20;

  const out = $("#groupAnswer");
  out.style.display = "block";

  try{
    startEllipsis(out, "처음에 말하기 좀 그래서 고민중");
    const res = await fetch("/chat/group",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ personas:list, topic, rounds, historyLimit:limit })
    });
    if(!res.ok){
      toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
      return;
    }
    const data = await res.json();
    if (!data?.ok) {
      toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
      return;
    }

    if (Array.isArray(data.transcript)) {
      const lines = data.transcript.map(it => `${it.speaker}: ${it.text}`).join("\n");
      const sum = data.summary ? `\n\n요약: ${data.summary}` : "";
      out.textContent = `${lines}${sum}`;
    } else {
      out.textContent = (data.transcript || data.summary || "").trim() || "(빈 응답)";
    }
  }catch(err){
    console.error(err);
    toast("라이브 API 연결 실패. 관리자에게 문의하세요.");
  } finally {
    stopEllipsis(out);
  }
});

// -------- 저장/편집/삭제
$("#btnSavePersona").addEventListener("click", ()=>{
  const p = {
    name: $("#pName").value.trim(),
    role: $("#pRole").value.trim(),
    traits: $("#pTraits").value.trim(),
    bio: $("#pBio").value.trim()
  };
  if(!p.name){ toast("이름은 필수입니다."); return; }

  if(editIndex !== null){
    updatePersona(editIndex, p);
    exitEditMode();
  }else{
    if(!addPersona(p)) return;
    clearForm();
  }
  renderPersonaList();
});
$("#btnCancelEdit").addEventListener("click", exitEditMode);
$("#btnLoadSamples").addEventListener("click", (e)=>{
  loadSamplePersonas(e.currentTarget, {
    replace: true,
    timeoutGAS: 12000,
    timeoutLocal: 5000
  });
});
document.getElementById("btnRefreshList")?.addEventListener("click", renderPersonaList);

// 초기화
renderPersonaList();

// --- JSON 백업/복원 (선택 기능)
function exportCacheAsJson() {
  const items = loadPersonasCache() || loadPersonas();
  const payload = { savedAt: Date.now(), items };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `personas-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importCacheFromJsonFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const parsed = JSON.parse(String(e.target.result||""));
      if (!parsed || !Array.isArray(parsed.items)) throw new Error("items 배열이 없음");
      savePersonasCache(parsed.items);
      savePersonas(parsed.items);
      renderPersonaList();
      toast("백업 JSON을 불러와 적용했습니다.");
    } catch (err) {
      toast("JSON 형식이 올바르지 않습니다: " + err.message);
    }
  };
  reader.readAsText(file);
}
document.getElementById("btnExportJson")?.addEventListener("click", exportCacheAsJson);
document.getElementById("btnImportJson")?.addEventListener("click", () => {
  document.getElementById("importJsonInput").click();
});
document.getElementById("importJsonInput")?.addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if (file) importCacheFromJsonFile(file);
});
</script>
</body>
</html>
