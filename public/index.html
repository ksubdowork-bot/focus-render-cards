<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BX AI Focus Group</title>
  <style>
    :root{
      --brand:#5b6cff;
      --brand-ghost:#eef0ff;
      --ink:#121418;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7f8fb;
      --ok:#10b981;
      --danger:#ef4444;
      --ans-bg:#1f2430;
      --ans-fg:#ffffff;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 30px rgba(41,53,108,.10);
      --shadow-sm:0 6px 18px rgba(41,53,108,.08);
      --chip:#f2f4f7;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
    }
    .wrap{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:20px; margin:0 0 16px; display:flex; gap:10px; align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#e9eefb; color:#4252d9}
    .mode-toggle{margin-left:auto; display:flex; gap:8px; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; padding:4px; border-radius:999px; box-shadow:var(--shadow-sm)
    }
    .pill input{display:none}
    .pill label{
      padding:6px 12px; border-radius:999px; cursor:pointer; color:var(--muted)
    }
    .pill input:checked + label{ background:var(--brand); color:#fff }

    .section{
      background:var(--card); border-radius:var(--radius);
      padding:18px; box-shadow:var(--shadow); margin:14px 0;
    }
    .sec-title{font-weight:700; margin:0 0 12px; font-size:16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .full{grid-column:1 / -1}
    input,textarea,select{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px;
      background:#fff; outline:none; transition:.15s; font:inherit;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-ghost)}
    textarea{min-height:96px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}

    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow:var(--shadow-sm); background:#f3f4f6; color:#111827;
    }
    .btn.primary{ background:var(--brand); color:#fff }
    .btn.ghost{ background:#fff }
    .btn.success{ background:var(--ok); color:#fff }
    .btn.danger{ background:#fff0f0; color:#b91c1c }

    .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px; margin-top:10px}
    .card{
      background:#fff; border:1px solid #eef0f4; border-radius:12px; padding:12px; display:flex; gap:10px; align-items:flex-start;
      box-shadow:var(--shadow-sm); position:relative;
    }
    .card .name{font-weight:700}
    .card .meta{font-size:12px; color:var(--muted); margin-top:2px}
    .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); font-size:12px; color:#555}

    .card .kebab{ position:absolute; top:8px; right:8px; display:flex; gap:6px }
    .tag { font-size:11px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#4f46e5 }

    .answer{
      background:var(--ans-bg); color:var(--ans-fg);
      border-radius:12px; padding:14px; white-space:pre-wrap; box-shadow:var(--shadow-sm)
    }
    .list-inline{display:flex; gap:8px; flex-wrap:wrap}
    .persona-pill{
      padding:10px 12px; border:1px dashed #e5e7eb; border-radius:12px; min-height:64px; background:#fff
    }

    @media (max-width:720px){
      .row{grid-template-columns:1fr}
      .mode-toggle{width:100%; justify-content:flex-end}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      AI 익스피리언스 포커스 그룹 by Exeprience Design TF
      <span id="modeBadge" class="badge">DEMO</span>
      <div class="mode-toggle">
        <div class="pill">
          <input type="radio" name="mode" id="modeDemo" value="demo" checked>
          <label for="modeDemo">Demo</label>
          <input type="radio" name="mode" id="modeLive" value="live">
          <label for="modeLive">Live</label>
        </div>
      </div>
    </h1>

    <!-- 1) 페르소나 입력/저장 -->
    <section class="section" id="secSave">
      <div class="sec-title">1) 페르소나 입력/저장 (최대 5명)</div>
      <div class="row">
        <div>
          <label>이름</label>
          <input id="pName" placeholder="예: 도경섭" />
        </div>
        <div>
          <label>모바일 기기</label>
          <input id="pRole" placeholder="예: 갤럭시 Z fold7" />
        </div>
        <div class="full">
          <label>핵심 성향(콤마 구분)</label>
          <input id="pTraits" placeholder="소셜미디어, 영포티아님, 패션, 여행, 육아" />
        </div>
        <div class="full">
          <label>상세 설명</label>
          <textarea id="pBio" placeholder="(자세할수록좋음)모바일 활용, 오프라인 체험에 관한 내용 등"></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnSavePersona">페르소나 저장</button>
        <button class="btn ghost" id="btnLoadSamples">2026소비자트랜드 페르소나</button>
        <button class="btn ghost" id="btnRefreshList">목록 새로고침</button>
      </div>

      <div class="hint">* 저장 후 아래 카드에서 “클릭”하면 해당 슬롯/그룹에 선택이 자동 적용</div>

      <div class="cards" id="personaList"></div>
    </section>
    

    <!-- 2) 솔로 대화 -->
    <section class="section" id="secSolo">
      <div class="sec-title">2) 솔로 질문 </div>
      <div class="row">
        <div class="full">
          <label>페르소나</label>
          <select id="soloPersonaSelect"></select>
        </div>
        <div>
          <label>대화 컨텍스트 반영</label>
          <select id="soloLimit">
            <option>10</option><option selected>20</option><option>30</option><option>50</option>
          </select>
        </div>
        <div class="full">
          <label>질문</label>
          <input id="soloQuestion" placeholder="예: 새로운 모바일기기를 구매한다면 어떤기능을 직접 써보고싶을까?" />
        </div>
      </div>
      <div class="btns">
        <button class="btn primary" id="btnAskSolo">질문하기</button>
      </div>
      <div id="soloAnswer" class="answer" style="margin-top:12px; display:none;"></div>
    </section>

    <!-- 3) 그룹 대화 -->
    <section class="section" id="secGroup">
      <div class="sec-title">3) 그룹 대화(최대 5명)</div>
      <div class="hint">아래 목록에서 페르소나를 선택하세요. 선택된 페르소나가 발언합니다.</div>

      <div id="groupSelected" class="list-inline" style="margin:8px 0 12px;"></div>

      <div class="row">
        <div class="full">
          <label>토픽 / 과제</label>
          <input id="groupTopic" placeholder="예: 갤럭시 팝업스토어에 간다면 무엇을 제일먼저 보고싶을까?" />
        </div>
        <div>
          <label>라운드 수(기본 2)</label>
          <select id="groupRounds"><option>1</option><option selected>2</option><option>3</option></select>
        </div>
        <div>
          <label>대화 컨텍스트 반영</label>
          <select id="groupLimit"><option>10</option><option selected>20</option><option>30</option><option>50</option></select>
        </div>
      </div>

      <div class="btns">
        <button class="btn success" id="btnStartGroup">그룹 대화 시작</button>
      </div>
      <div id="groupAnswer" class="answer" style="margin-top:12px; display:none;"></div>
    </section>
  </div>
 <footer style="
    bottom:0;
    left:0;
    width:100%;
    text-align:center;
    font-size:12px;
    color:#6b7280;
    background:#f7f8fb;  /* 배경색을 페이지와 통일 */
    padding:8px 0;
    border-top:1px solid #e5e7eb;
  ">
    익스피리언스 TF 제작
  </footer>

  <script>
    // -------- 상태 & 유틸
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const modeBadge = $("#modeBadge");
    const modeDemo = $("#modeDemo");
    const modeLive = $("#modeLive");

    const LSK = "personas.v1"; // localStorage key

    function toast(msg){ alert(msg); }

    function loadPersonas(){
      try{
        const arr = JSON.parse(localStorage.getItem(LSK) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(_){return [];}
    }
    function savePersonas(arr){
      localStorage.setItem(LSK, JSON.stringify(arr.slice(0,5)));
    }
    function addPersona(p){
      const arr = loadPersonas();
      if(arr.length >= 5){ toast("최대 5명까지 저장할 수 있어요."); return false; }
      arr.unshift(p);
      savePersonas(arr);
      return true;
    }
    function updatePersona(idx, p){
      const arr = loadPersonas();
      if(arr[idx]){ arr[idx] = p; savePersonas(arr); }
    }
    function deletePersona(idx){
      const arr = loadPersonas();
      arr.splice(idx,1);
      savePersonas(arr);
    }

    function renderPersonaList(){
      const list = loadPersonas();
      const box = $("#personaList");
      box.innerHTML = "";
      list.forEach((p, idx) => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div style="flex:1">
            <div class="name">${esc(p.name || "이름없음")}</div>
            <div class="meta">${esc(p.role || "")}</div>
            <div class="meta" style="margin-top:6px">${esc(p.traits || "")}</div>
          </div>
          <div class="kebab">
            <button class="btn ghost" data-edit>편집</button>
            <button class="btn danger" data-del>삭제</button>
          </div>
        `;
        // 클릭하면 솔로/그룹 선택 적용
        el.addEventListener("click", (e)=>{
          if(e.target.matches("[data-del]")) return; // 삭제버튼은 별도 처리
          if(e.target.matches("[data-edit]")) return; // 편집버튼은 별도 처리
          applyPersonaToSelectors(p);
        });
        // 삭제
        el.querySelector("[data-del]").addEventListener("click",(e)=>{
          e.stopPropagation();
          if(confirm("이 페르소나를 삭제할까요?")){
            deletePersona(idx);
            renderPersonaList();
            refreshSelectors();
          }
        });
        // 편집
        el.querySelector("[data-edit]").addEventListener("click",(e)=>{
          e.stopPropagation();
          const np = promptEditPersona(p);
          if(np){
            updatePersona(idx, np);
            renderPersonaList();
            refreshSelectors();
          }
        });
        box.appendChild(el);
      });
      refreshSelectors();
      renderGroupPickArea();
    }

    function promptEditPersona(old){
      const name = prompt("이름", old.name || "");
      if(name===null) return null;
      const role = prompt("모바일 기기", old.role || "");
      if(role===null) return null;
      const traits = prompt("핵심 성향(콤마 구분)", old.traits || "");
      if(traits===null) return null;
      const bio = prompt("상세 설명", old.bio || "");
      if(bio===null) return null;
      return {name:name.trim(), role:role.trim(), traits:traits.trim(), bio:bio.trim()};
    }

    function esc(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // 솔로/그룹 선택박스 채우기
    function refreshSelectors(){
      const list = loadPersonas();
      const sel = $("#soloPersonaSelect");
      const v = sel.value;
      sel.innerHTML = list.map(p => `<option value="${esc(p.name)}">${esc(p.name)}</option>`).join("");
      if(list.length===0) sel.innerHTML = `<option value="" disabled selected>저장된 페르소나 없음</option>`;
      else if(v && list.some(p=>p.name===v)) sel.value = v;
      renderGroupPickArea();
    }

    function applyPersonaToSelectors(p){
      // 솔로 선택 박스
      const sel = $("#soloPersonaSelect");
      sel.value = p.name;
      // 그룹 선택칩 토글
      toggleGroupPerson(p.name);
    }

    // 그룹 선택 UI
    function renderGroupPickArea(){
      const box = $("#groupSelected");
      const list = loadPersonas();
      box.innerHTML = "";
      list.forEach(p=>{
        const chip = document.createElement("div");
        chip.className = "persona-pill";
        chip.dataset.name = p.name;
        chip.innerHTML = `<div style="font-weight:700">${esc(p.name)}</div><div class="meta">${esc(p.role)}</div><div class="meta">${esc(p.traits)}</div>`;
        chip.addEventListener("click", ()=> toggleGroupPerson(p.name));
        box.appendChild(chip);
      });
      updateGroupSelectedStyles();
    }
    function getGroupSelected(){
      const set = JSON.parse(sessionStorage.getItem("group.selected")||"[]");
      return Array.isArray(set)? set : [];
    }
    function setGroupSelected(arr){
      sessionStorage.setItem("group.selected", JSON.stringify(arr.slice(0,5)));
      updateGroupSelectedStyles();
    }
    function toggleGroupPerson(name){
      let arr = getGroupSelected();
      if(arr.includes(name)) arr = arr.filter(x=>x!==name);
      else{
        if(arr.length>=5){ toast("그룹은 최대 5명까지 선택 가능합니다."); return; }
        arr.push(name);
      }
      setGroupSelected(arr);
    }
    function updateGroupSelectedStyles(){
      const selected = new Set(getGroupSelected());
      $$("#groupSelected .persona-pill").forEach(el=>{
        if(selected.has(el.dataset.name)){
          el.style.borderColor = "var(--brand)";
          el.style.background = "#fafaff";
        }else{
          el.style.borderColor = "#e5e7eb";
          el.style.background = "#fff";
        }
      });
    }

    // ---------- (수정) 샘플: 서버 우선, 실패 시 하드코딩 4명으로 폴백
    async function loadSamplePersonas(){
      const fallback = [
        {name:"도경섭", role:"아이폰 16 pro", traits:"아이폰, 최종주자, 40대, 가성비", bio:"데이터 기반 의사결정, SNS활동"},
        {name:"한주명", role:"아이폰 16 pro", traits:"실용주의, 데이터중심, 가성비, SNS활동", bio:"브랜드 관심 높음, 유튜브/인스타 소비"},
        {name:"정우주", role:"아이폰 17", traits:"아이폰, 미니멀, 30대", bio:"꼼꼼하고 체계적인 의사결정"},
        {name:"김수정", role:"아이폰 17", traits:"안드로이드, 가성비, 리뷰 헤비", bio:"체험단/리뷰 신뢰 높음"}
      ];
      try{
        const r = await fetch("/personas-list");
        if(!r.ok) throw new Error("server list failed");
        const data = await r.json(); // {ok, items}
        const items = (data && data.ok && Array.isArray(data.items) && data.items.length) ? data.items : fallback;
        const cur = loadPersonas();
        // 이름 기준 중복 제거
        const merged = [...items, ...cur].reduce((acc,p)=>{
          if(!acc.find(x=>x.name===p.name)) acc.push({name:p.name, role:p.role, traits:p.traits, bio:p.bio});
          return acc;
        }, []).slice(0,5);
        savePersonas(merged);
        renderPersonaList();
      }catch(_){
        const cur = loadPersonas();
        const merged = [...fallback, ...cur].reduce((acc,p)=>{
          if(!acc.find(x=>x.name===p.name)) acc.push(p);
          return acc;
        }, []).slice(0,5);
        savePersonas(merged);
        renderPersonaList();
      }
    }

    // -------- 모드 토글
    function currentMode(){ return modeLive.checked ? "live" : "demo"; }
    modeDemo.addEventListener("change", ()=> modeChanged());
    modeLive.addEventListener("change", ()=> modeChanged());
    function modeChanged(){
      const m = currentMode();
      modeBadge.textContent = m==="live" ? "LIVE" : "DEMO";
      modeBadge.style.background = m==="live" ? "#e6fff3" : "#e9eefb";
      modeBadge.style.color = m==="live" ? "#15803d" : "#4252d9";
    }

    // -------- 솔로 대화
    $("#btnAskSolo").addEventListener("click", async ()=>{
      const name = $("#soloPersonaSelect").value;
      const q = $("#soloQuestion").value.trim();
      const limit = parseInt($("#soloLimit").value,10) || 20;
      if(!name) return toast("페르소나를 선택하세요.");
      if(!q) return toast("질문을 적어주세요.");
      const p = loadPersonas().find(x=>x.name===name);
      if(!p) return toast("선택한 페르소나를 찾을 수 없습니다.");

      const out = $("#soloAnswer");
      out.style.display = "block";
      if(currentMode()==="demo"){
        out.textContent = `[DEMO] ${p.name}의 시점으로 답변합니다.\n\nQ. ${q}\n\n- (데모 응답) 실제 모드는 서버 API 연결 후 작동합니다.`;
        return;
      }
      // LIVE 호출
      try{
        out.textContent = "[LIVE] AI 응답 작성중...";
        const res = await fetch("/chat/solo",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ persona:p, question:q, historyLimit:limit })
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`HTTP ${res.status} - ${t}`);
        }
        const data = await res.json();
        out.textContent = (data.answer||"").trim() || "(빈 응답)";
      }catch(err){
        out.textContent = `오류: ${err.message}`;
      }
    });

    // -------- 그룹 대화
    $("#btnStartGroup").addEventListener("click", async ()=>{
      const names = getGroupSelected();
      const list = loadPersonas().filter(p=>names.includes(p.name));
      if(list.length===0) return toast("그룹에 참여시킬 페르소나를 한 명 이상 선택하세요.");
      const topic = $("#groupTopic").value.trim() || "자유 토론";
      const rounds = parseInt($("#groupRounds").value,10) || 2;
      const limit = parseInt($("#groupLimit").value,10) || 20;

      const out = $("#groupAnswer");
      out.style.display = "block";
      if(currentMode()==="demo"){
        const heads = list.map(p=>p.name).join(", ");
        out.textContent = `[DEMO] (${heads}) 라운드 ${rounds}회 대화 요약.\n\n- (데모 응답) 실제 모드는 서버 API 연결 후 작동합니다.`;
        return;
      }
      // LIVE 호출
      try{
        out.textContent = "[LIVE] 그룹 대화 내용 기록중...";
        const res = await fetch("/chat/group",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ personas:list, topic, rounds, historyLimit:limit })
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`HTTP ${res.status} - ${t}`);
        }
        const data = await res.json();

        // (수정) transcript 배열 + summary 지원
        if (Array.isArray(data.transcript)) {
          const lines = data.transcript.map(it => `${it.speaker}: ${it.text}`).join("\n");
          const sum = data.summary ? `\n\n요약: ${data.summary}` : "";
          out.textContent = `${lines}${sum}`;
        } else {
          // 서버가 문자열만 줄 때
          out.textContent = (data.transcript || data.summary || "").trim() || "(빈 응답)";
        }
      }catch(err){
        out.textContent = `오류: ${err.message}`;
      }
    });

    // -------- 저장/편집/삭제
    $("#btnSavePersona").addEventListener("click", ()=>{
      const p = {
        name: $("#pName").value.trim(),
        role: $("#pRole").value.trim(),
        traits: $("#pTraits").value.trim(),
        bio: $("#pBio").value.trim()
      };
      if(!p.name){ toast("이름은 필수입니다."); return; }
      if(addPersona(p)){
        $("#pName").value = $("#pRole").value = $("#pTraits").value = $("#pBio").value = "";
        renderPersonaList();
      }
    });
    $("#btnLoadSamples").addEventListener("click", loadSamplePersonas);
    $("#btnRefreshList").addEventListener("click", renderPersonaList);

    // 초기화
    modeChanged();
    renderPersonaList();
  </script>
</body>
</html>
